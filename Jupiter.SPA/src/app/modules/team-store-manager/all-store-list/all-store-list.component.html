<div class="filterTabParent">
  <!-- <form (ngSubmit)="getStoreRequestList()"> -->
  <div class="row filterTabBar">
    <div class="col-md-2 ml-1">
      <!-- <mat-form-field style="width: 100%">
            <mat-label>Manager</mat-label>
            <mat-select formControlName="manager" (selectionChange)="getStoreRequestList()">
              <mat-option [value]="manager.id" *ngFor="let manager of managerList">{{manager.name}}</mat-option>
            </mat-select>
          </mat-form-field> -->
    </div>
    <div class="col-md-2">
      <mat-form-field>
        <mat-label>Close Date From</mat-label>
        <input
          matInput
          [matDatepicker]="fromPicker"
          [(ngModel)]="dateFilters.closeDateFrom"
        />
        <mat-datepicker-toggle
          matSuffix
          [for]="fromPicker"
        ></mat-datepicker-toggle>
        <mat-datepicker #fromPicker></mat-datepicker>
      </mat-form-field>
    </div>
    <div class="col-md-2">
      <mat-form-field style="height: 20px">
        <mat-label>Close Date To</mat-label>
        <input
          matInput
          [matDatepicker]="toPicker"
          [min]="minDate"
          [(ngModel)]="dateFilters.closeDateTo"
        />
        <mat-datepicker-toggle
          matSuffix
          [for]="toPicker"
        ></mat-datepicker-toggle>
        <mat-datepicker #toPicker></mat-datepicker>
      </mat-form-field>
    </div>
    <div class="col-md-2">
      <!-- <mat-form-field style="width: 100%">
        <mat-label>Status</mat-label>
        <mat-select [(ngModel)]="filterParams.type" (selectionChange)="getStoreRequestList()" multiple>
          <mat-option value="1">Pending</mat-option>
          <mat-option value="2">Requested</mat-option>
          <mat-option value="3">Assigned to Builder</mat-option>
          <mat-option value="4">Building Store</mat-option>
          <mat-option value="5">Proofing Store</mat-option>
          <mat-option value="6">Submitted for Approval</mat-option>
          <mat-option value="7">Making Adjustments</mat-option>
          <mat-option value="8">Waiting for Finalizing</mat-option>
          <mat-option value="9">Store Published</mat-option>
          <mat-option value="10">Store Opened</mat-option>
          <mat-option value="11">Store Closed</mat-option>
          <mat-option value="15">Store Art Inprogress</mat-option>
          <mat-option value="19">Customer Rejected</mat-option>
          <mat-option value="20">Customer Approved</mat-option>
        </mat-select>
      </mat-form-field> -->
    </div>
    <div class="col-md-2">
      <div class="wrapper">
        <!-- <img class="search-icon" src="../../../../assets/images/search.png" /> -->
        <!-- <input class="search" formControlName="name" placeholder="Search" type="text" /> -->
      </div>
      <button
        type="submit"
        class="btn btn-primary"
        style="
          height: 0px;
          width: 0px;
          padding: 0px !important;
          border: 0px !important;
        "
      ></button>
    </div>
    <div class="col" style="padding: 10px">
      <button
        type="submit"
        class="btn btn-primary"
        (click)="getStoreRequestList()"
      >
        Filter
      </button>
    </div>
    <div class="col" style="padding: 10px">
      <button type="btn" class="btn btn-primary" (click)="clearFilters()">
        Clear Filters
      </button>
    </div>
  </div>
  <!-- </form> -->
</div>
<br />
<div class="table-wrapper">
  <table
    mat-table
    [dataSource]="dataSource"
    multiTemplateDataRows
    class="mat-elevation-z8"
  >
    <ng-container matColumnDef="name">
      <th mat-header-cell *matHeaderCellDef>Store Name</th>
      <td mat-cell *matCellDef="let element">{{ element.name }}</td>
    </ng-container>
    <ng-container matColumnDef="contactName">
      <th mat-header-cell *matHeaderCellDef>Store Owner</th>
      <td mat-cell *matCellDef="let element">{{ element.contactName }}</td>
    </ng-container>
    <ng-container matColumnDef="storeId">
      <th mat-header-cell *matHeaderCellDef>Store Id</th>
      <td mat-cell *matCellDef="let element">{{ element.id }}</td>
    </ng-container>
    <ng-container matColumnDef="accountManager">
      <th mat-header-cell *matHeaderCellDef>Account Manager</th>
      <td mat-cell *matCellDef="let element">{{ element.accountManager }}</td>
    </ng-container>
    <ng-container matColumnDef="isUserVerified">
      <th mat-header-cell *matHeaderCellDef>Customer Verified</th>
      <td mat-cell *matCellDef="let element">
        <label *ngIf="element.isUserVerified == 0">Pending</label>
        <label *ngIf="element.isUserVerified == 1">Rejected</label>
        <label *ngIf="element.isUserVerified == 2">Approved</label>
      </td>
    </ng-container>
    <ng-container matColumnDef="stage">
      <th mat-header-cell *matHeaderCellDef>Store Status</th>
      <td mat-cell *matCellDef="let element">
        <label *ngIf="element.stage == 1">Pending</label>
        <label *ngIf="element.stage == 2">Requested</label>
        <label *ngIf="element.stage == 4">Assigned To Builder</label>
        <label *ngIf="element.stage == 5">Proofing Store</label>
        <label *ngIf="element.stage == 6">Submitted for Approval</label>
        <label *ngIf="element.stage == 7">Making Adjustments</label>
        <label *ngIf="element.stage == 8">Waiting for Finalizing</label>
        <label *ngIf="
            element.stage == 3 ||
            element.stage == 18 ||
            element.stage == 15
          ">
          Build In Progress</label>
        <label *ngIf="element.stage == 9">Store Published</label>
        <label *ngIf="element.stage == 10">Store Opened</label>
        <label *ngIf="element.stage == 11">Store Closed</label>
        <label *ngIf="element.stage == 19">Customer Rejected</label>
        <label *ngIf="element.stage == 20">Customer Approved</label>
      </td>
    </ng-container>
    <ng-container matColumnDef="closeDate">
      <th mat-header-cell *matHeaderCellDef>Closing Date</th>
      <td mat-cell *matCellDef="let element">
        {{ element.closeDate | date: "MM/dd/yyyy hh:mm a" }}
      </td>
    </ng-container>
    <ng-container matColumnDef="viewStore">
      <th mat-header-cell *matHeaderCellDef></th>
      <td mat-cell *matCellDef="let element" class="text-center">
        <!-- <button class="btn" (click)="openInfoModal(element)">
          <mat-icon aria-hidden="false" aria-label="notes" >assignment</mat-icon>
        </button> -->
        <button
          class="btn btn-outline-dark btn-sm"
          (click)="viewRejectionNotes(element)"
          *ngIf="element.stage == 7 || element.stage == 19"
          data-toggle="modal" data-target="#rejectionInfoModal"
        >
          Rejection Notes
        </button>
        <button
          class="btn btn-outline-info btn-sm"
          (click)="viewOrderStatus(element.id)"
          *ngIf="(element.stage == 10 || element.stage == 11) && (element.stage != 50)"
        >
          View Order Status
        </button>
      </td>
    </ng-container>

    <!-- Expanded Content Column - The detail row is made up of this one column that spans across all columns -->
    <ng-container matColumnDef="expandedDetail">
      <td
        mat-cell
        *matCellDef="let element"
        [attr.colspan]="columnsToDisplay.length"
      >
        <div
          class="example-element-detail"
          [@detailExpand]="
            element == expandedElement ? 'expanded' : 'collapsed'
          "
        >
          <button
            *ngIf="element.stage == 6"
            mat-raised-button
            color="primary"
            (click)="verifyStoreBuild(element.id)"
          >
            Verify Store Build
          </button>
          <button
            *ngIf="element.stage == 6"
            mat-raised-button
            color="primary"
            (click)="verifyArt(element)"
          >
            View Art
          </button>
          <button
            *ngIf="element.stage == 6"
            mat-raised-button
            color="primary"
            (click)="updateStoreStage(element, 9)"
          >
            Publish Store
          </button>
          <button
            *ngIf="element.stage == 20"
            mat-raised-button
            color="primary"
            (click)="updateStoreStage(element, 10)"
          >
            Open Store
          </button>
          <button
            *ngIf="element.stage == 10"
            mat-raised-button
            color="primary"
            (click)="updateStoreStage(element, 11)"
          >
            Close Store
          </button>
          <button
            *ngIf="element.stage == 11"
            mat-raised-button
            color="primary"
            (click)="republishStore(element)"
          >
            Re-Publish Store
          </button>
          <button
            mat-raised-button
            color="primary"
            (click)="openStoreClosureModal(element)"
            *ngIf="element.stage == 10"
          >
            Edit Store Closure Date
          </button>
          <button
            *ngIf="
              [10, 11, 9].includes(element.stage) && element.availableToCopy
            "
            mat-raised-button
            color="primary"
            (click)="copyLayout(element.id)"
          >
            Copy Store Layout
          </button>
        </div>
      </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="columnsToDisplay; sticky: true"></tr>
    <tr
      mat-row
      *matRowDef="let element; columns: columnsToDisplay"
      class="example-element-row"
      [class.example-expanded-row]="expandedElement === element"
      (click)="expandedElement = expandedElement === element ? null : element"
    ></tr>
    <tr
      mat-row
      *matRowDef="let row; columns: ['expandedDetail']"
      class="example-detail-row"
    ></tr>
    <th mat-header-row *matHeaderRowDef style="padding: 10px 10px 10px 0">
      <input
        type="text"
        [(ngModel)]="filterParams.storeId"
        placeholder="Store Id"
        (change)="getStoreRequestList()"
      />
    </th>
    <th mat-header-row *matHeaderRowDef style="padding: 10px 10px 10px 0">
      <input
        type="text"
        [(ngModel)]="filterParams.name"
        placeholder="Store Name"
        (change)="getStoreRequestList()"
      />
    </th>
    <th mat-header-row *matHeaderRowDef style="padding: 10px 10px 10px 0">
      <input
        type="text"
        [(ngModel)]="filterParams.contactName"
        placeholder="Store Owner"
        (change)="getStoreRequestList()"
      />
    </th>
    <th mat-header-row *matHeaderRowDef style="padding: 10px 10px 10px 0">
      <!-- <input type="text" [(ngModel)]="filterParams.accountManagerId" placeholder="Account Manager"
      (change)="getStoreRequestList()" /> -->
      <mat-form-field style="width: 100%">
        <mat-label></mat-label>
        <mat-select
          [(ngModel)]="filterParams.accountManagerId"
          (selectionChange)="getStoreRequestList()"
        >
          <mat-option [value]="0">All</mat-option>
          <mat-option [value]="mgr.id" *ngFor="let mgr of managerList">{{
            mgr.name
          }}</mat-option>
        </mat-select>
      </mat-form-field>
    </th>
    <th mat-header-row *matHeaderRowDef style="padding: 10px 10px 10px 0">
      <mat-form-field style="width: 100%">
        <mat-label>Status</mat-label>
        <mat-select
          [(ngModel)]="filterParams.type"
          (selectionChange)="getStoreRequestList()"
          multiple
        >
          <!-- <mat-option value="1">Pending</mat-option>
          <mat-option value="2">Requested</mat-option>
          <mat-option value="3">Assigned to Builder</mat-option>
          <mat-option value="4">Build in Progress</mat-option>
          <mat-option value="5">Proofing Store</mat-option>
          <mat-option value="6">Submitted for Approval</mat-option>
          <mat-option value="7">Making Adjustments</mat-option>
          <mat-option value="8">Waiting for Finalizing</mat-option>
          <mat-option value="9">Store Published</mat-option>
          <mat-option value="10">Store Opened</mat-option>
          <mat-option value="11">Store Closed</mat-option>
          <mat-option value="15">Store Art Inprogress</mat-option>
          <mat-option value="19">Customer Rejected</mat-option>
          <mat-option value="20">Customer Approved</mat-option> -->
          <mat-option value="1">Pending</mat-option>
          <mat-option value="2">Requested</mat-option>
          <mat-option value="4">Assigned to Builder</mat-option>
          <mat-option value="15">Build in Progress</mat-option>
          <mat-option value="5">Proofing Store</mat-option>
          <mat-option value="6">Submitted for Approval</mat-option>
          <mat-option value="7">Making Adjustments</mat-option>
          <mat-option value="8">Waiting for Finalizing</mat-option>
          <mat-option value="9">Store Published</mat-option>
          <mat-option value="10">Store Opened</mat-option>
          <mat-option value="11">Store Closed</mat-option>
          <mat-option value="19">Customer Rejected</mat-option>
          <mat-option value="20">Customer Approved</mat-option>
        </mat-select>
      </mat-form-field>
    </th>
    <th mat-header-row *matHeaderRowDef style="padding: 10px 10px 10px 0">
      <mat-form-field style="width: 100%">
        <mat-label></mat-label>
        <mat-select
          [(ngModel)]="filterParams.isUserVerified"
          (selectionChange)="getStoreRequestList()"
        >
          <mat-option [value]="0">All</mat-option>
          <mat-option [value]="2">Approved</mat-option>
          <mat-option [value]="1">Rejected</mat-option>
        </mat-select>
      </mat-form-field>
    </th>
  </table>
  <mat-paginator
    (page)="onPage($event)"
    [length]="filterParams.totalLength"
    [pageSize]="filterParams.per_page"
    [pageSizeOptions]="filterParams.pageSizeOptions"
    aria-label="Select page"
  >
  </mat-paginator>
</div>

<div class="modal fade" id="storeClosureModal" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">
          &times;
        </button>
      </div>
      <div class="modal-body">
        <form [formGroup]="storeForm" (ngSubmit)="updateStoreClosure()">
          <!-- <mat-form-field style="width: 100%;">
              <mat-label>Close Date</mat-label>
              <input matInput [matDatepicker]="closeDate" formControlName="closeDate" (click)="closeDate.open()" />
              <mat-datepicker-toggle matSuffix [for]="closeDate"></mat-datepicker-toggle>
              <mat-datepicker #closeDate></mat-datepicker>
            </mat-form-field> -->
          <mat-form-field style="width: 100%">
            <mat-label>Close Date</mat-label>
            <input
              matInput
              [ngxMatDatetimePicker]="closeDate"
              formControlName="closeDate"
              (click)="closeDate.open()"
              [min]="storeForm.value.minDate"
              readonly
              (dateInput)="invalidClosingDay()"
            />
            <mat-error *ngIf="storeForm.get('closeDate').errors?.required">
              Close Date is required
            </mat-error>
            <mat-error
              *ngIf="storeForm.get('closeDate').errors?.matDatepickerMin"
            >
              Close Date is not valid
            </mat-error>
            <mat-error *ngIf="storeForm.get('closeDate').errors?.invalidDay">
              Close Date cannot be Friday or Saturday
            </mat-error>
            <mat-datepicker-toggle
              matSuffix
              [for]="closeDate"
            ></mat-datepicker-toggle>
            <ngx-mat-datetime-picker
              #closeDate
              [enableMeridian]="true"
            ></ngx-mat-datetime-picker>
          </mat-form-field>
          <br /><br />
          <button
            type="submit"
            [disabled]="loading"
            class="btn btn-primary commonBtnStyle"
          >
            <span
              *ngIf="loading"
              class="spinner-border spinner-border-sm mr-1"
            ></span>
            update
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="rejectionInfoModal" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5>Rejection Reason</h5>
        <button type="button" class="close" data-dismiss="modal">
          &times;
        </button>
      </div>
      <div class="modal-body">
        <div *ngFor="let code of rejectionInfo?.codes">
          <label>
            {{ code }}
          </label>
        </div>
        <mat-form-field style="width: 100%">
          <mat-label>Comment</mat-label>
          <textarea
            readonly
            matInput
            [(ngModel)]="rejectionInfo.text"
          ></textarea>
        </mat-form-field>
      </div>
    </div>
  </div>
</div>
